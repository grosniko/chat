<html>
    <head>
      <style>
      :root {
  --body-bg: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
  --msger-bg: #fff;
  --border: 2px solid #ddd;
  --left-msg-bg: #ececec;
  --right-msg-bg: #579ffb;
}

html {
  box-sizing: border-box;
}

*,
*:before,
*:after {
  margin: 0;
  padding: 0;
  box-sizing: inherit;
  font-size: 2.3vh;
}

body {
  display: flex;
  justify-content: center;
  align-items: center;
  height: 100%;
  background-image: var(--body-bg);
  font-family: Helvetica, sans-serif;
}

textarea {
  font-family: Helvetica, sans-serif;
  font-size: 18px !important;
}

.msger {
  max-width:857px;
  display: flex;
  flex-flow: column wrap;
  justify-content: space-between;
  width: 100%;
  margin:0 auto;
  /* max-width: 100%; */
  /* margin: 25px 10px; */
  margin: 0 0;
  height: 100%;
  border: var(--border);
  border-radius: 5px;
  background: var(--msger-bg);
  box-shadow: 0 15px 15px -5px rgba(0, 0, 0, 0.2);
}

.msger-header {
  display: flex;
  justify-content: space-between;
  padding: 10px;
  border-bottom: var(--border);
  background: #eee;
  color: #666;
}

.msger-chat {
  flex: 1;
  overflow-y: auto;
  padding: 10px;
}
.msger-chat::-webkit-scrollbar {
  width: 6px;
}
.msger-chat::-webkit-scrollbar-track {
  background: #ddd;
}
.msger-chat::-webkit-scrollbar-thumb {
  background: #bdbdbd;
}
.msg {
  display: flex;
  align-items: flex-end;
  margin-bottom: 10px;
}
.msg:last-of-type {
  margin: 0;
}
.msg-img {
  width: 50px;
  height: 50px;
  margin-right: 10px;
  background: #ddd;
  background-repeat: no-repeat;
  background-position: center;
  background-size: cover;
  border-radius: 50%;
}
.msg-bubble {
  max-width: 450px;
  padding: 15px;
  border-radius: 15px;
  background: var(--left-msg-bg);
}
.msg-info {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 10px;
}
.msg-info-name {
  margin-right: 10px;
  font-weight: bold;
}
.msg-info-time {
  font-size: 0.85em;
}

.left-msg .msg-bubble {
  border-bottom-left-radius: 0;
}

.right-msg {
  flex-direction: row-reverse;
}
.right-msg .msg-bubble {
  background: var(--right-msg-bg);
  color: #fff;
  border-bottom-right-radius: 0;
}
.right-msg .msg-img {
  margin: 0 0 0 10px;
}

.msger-inputarea {
  display: flex;
  padding: 10px;
  border-top: var(--border);
  background: #eee;
}
.msger-inputarea * {
  padding: 10px;
  border: none;
  border-radius: 3px;
  font-size: 1em;
}
.msger-input {
  flex: 1;
  background: #ddd;
}
.msger-send-btn {
  margin-left: 10px;
  background: rgb(0, 196, 65);
  color: #fff;
  font-weight: bold;
  cursor: pointer;
  transition: background 0.23s;
}
.msger-send-btn:hover {
  background: rgb(0, 180, 50);
}

.msger-chat {
  background: linear-gradient(325deg, rgb(255 199 0 / 50%), transparent);
}
:root {
  --body-bg: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
  --msger-bg: #fff;
  --border: 2px solid #ddd;
  --left-msg-bg: #ececec;
  --right-msg-bg: #579ffb;
}


.statusUpdate {
  text-align:center;
  font-style:italic;
  color:grey;
}


.proposal {
    text-align: left;
    margin: 10px;
    padding: 10px;
    border-radius: 5px;
    background-color: #FFC770;
    color: white;
    font-weight: 800;
}

/* ADD TO CALENDAR */
body {
	 background: #1D1F20;
}
 .atc-wrapper {
	 width: 180px;
	 height: 40px;
	 margin: 20px auto;
}
 .atc-checkbox-label {
	 width: 100%;
	 height: 100%;
	 display: block;
	 background: red;
	 color: white;
	 line-height: 40px;
	 text-align: center;
	 cursor: pointer;
	 position: relative;
	 z-index: 1;
	 user-select: none;
}
 .atc-links-wrapper {
	 background: white;
	 transition: transform .5s, opacity .1s;
	 border: 0 solid red;
	 border-left-width: 1px;
	 border-right-width: 1px;
	 box-sizing: border-box;
	 transform: translateY(-100%);
	 width: 100%;
	 opacity: 0;
}
 .atc-link {
	 line-height: 40px;
	 display: block;
	 width: 100%;
	 text-decoration: none;
	 text-align: center;
	 background: white;
	 color: red;
	 pointer-events: none;
	 border-bottom: 1px solid red;
	 position: relative;
	 transition: background .5s, color .5s;
}
 .atc-link:hover {
	 background: red;
	 color: white;
}
 .atc-checkbox {
	 display: none;
}
 .atc-checkbox:checked + .atc-links-wrapper {
	 transform: translateY(0);
	 opacity: 1;
	 transition: transform .5s, opacity .5s .2s;
}
 .atc-checkbox:checked + .atc-links-wrapper .atc-link {
	 pointer-events: auto;
}



      </style>
      <meta name="viewport" content="width=device-width, initial-scale=1">
      <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">


        <title>Wildcard Chat: {{ name }}</title>
        <script type="text/javascript" src="//code.jquery.com/jquery-1.4.2.min.js"></script>
        <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/socket.io/1.3.6/socket.io.min.js"></script>
        <script type="text/javascript" charset="utf-8">
            var socket;
            $(document).ready(function(){



                socket = io.connect('http://' + document.domain + ':' + location.port + '/chat');
                socket.on('connect', function() {

                    socket.emit('joined', {'id': socket.id, 'date': new Date()})


                });

                socket.on('status', function(data) {
                    addStatus(data.msg);
                    $('#chatarea').scrollTop($('#chatarea')[0].scrollHeight);
                });

                socket.on('disconnect', function () {
                      socket.emit('disconnected', {});
                    });

                socket.on('message', function(data) {

                    addChat(data.msg)
                    // $('#chat').val($('#chat').val() + data.msg + '\n');
                    $('#chatarea').scrollTop($('#chatarea')[0].scrollHeight);
                });

                //Send text on enter
                // $('#text').keypress(function(e) {
                //     var code = e.keyCode || e.which;
                //     if (code == 13) {
                //       sendText()
                //     }
                // });
                //sometimes this never happens on iphone safari, so reload if nothing in 1.5 seconds
                let refresh = setTimeout(function(){window.location.reload(1); }, 1000)
                socket.on('chatHistory', function (data) {
                      //stop reload if it happens
                      clearTimeout(refresh)
                      loadChat(data)
                    });

                socket.on('game', function (data) {
                      addGame(data)
                    });

            });
            function leave_room() {
                socket.emit('left', {}, function() {
                    socket.disconnect();

                    // go back to the login page
                    window.location.href = "{{ url_for('main.index') }}";
                });
            }
        </script>
    </head>
    <!-- <body> -->
        <section id="messenger" class="msger">
          <!-- <header class="msger-header">
            <div class="msger-header-title">
              <i class="fas fa-comment-alt"></i> Wildcard Chat
            </div>
            <div class="msger-header-options">
              <span><i class="fas fa-cog"></i></span>
            </div>
          </header> -->

          <main class="msger-chat" id="chatarea" mid={{ mid }}>

          </main>

          <div class="msger-inputarea">
            <!-- <input type="text" id="text" class="msger-input" placeholder="Votre message..."> -->
            <textarea rows=2 id="text" class="msger-input" placeholder="Votre message..."></textarea>
            <button type="submit" class="msger-send-btn" onclick="sendText()">Poster</button>
          </div>
        </section>

        <a href="#" onclick="leave_room();"></a>
    <!-- </body> -->

<script>

function buildMessage(name, mid, clientMid, message, date){
  var msgclass = ""


  // https://image.flaticon.com/icons/svg/145/145867.svg
  // https://image.flaticon.com/icons/svg/327/327779.svg

  if(mid == clientMid){
    msgclass = '<div class="msg right-msg">'
    // '<div class="msg-img" style="background-image: url({{url_for("static", filename="/img/512.png")}})" ></div>'
  } else {
    msgclass = '<div class="msg left-msg">'
    // '<div class="msg-img" style="background-image: url({{url_for("static", filename="/img/512_2.png")}})" ></div>'
  }

  var msgHTML = msgclass +
    '<div class="msg-bubble"> <div class="msg-info"> <div class="msg-info-name">' +
    name +
    '</div> <div class="msg-info-time">'+formatDate(date)+'</div> </div> <div class="msg-text">' +
    message +
    '</div> </div> </div>'

  return msgHTML
}


function addChat(data){
  var chatarea = document.querySelector("#chatarea")
  var clientMid = chatarea.getAttribute("mid")
  var items = data.split(" ]____[ ")
  var name = items[0]
  var message = items[1]
  var mid = items[2]
  var date = new Date()

  chatarea.innerHTML += buildMessage(name, mid, clientMid, message, date)
}

function loadChat(data){

  var chatarea = document.querySelector("#chatarea")
  var userName = chatarea.getAttribute("name")
  chatarea.innerHTML = ""
  var chatHistory = data["chatHistory"]
  let statusDate = ""
  if(data['chatHistory'][0]["type"] == "proposal"){
    statusDate = new Date(1000 * data['chatHistory'][0]["timestamp"]) //turn to javascript
  } else {
    statusDate = new Date(data['chatHistory'][0]["localDate"])
  }



  addHistoryStatus(statusDate)
  for(var i = 0; i < chatHistory.length; i++){
    if(chatHistory[i]["type"]=="text"){
      var items = chatHistory[i]["message"].split(" ]____[ ")
      var clientMid = chatarea.getAttribute("mid")
      var name = items[0]
      var message = items[1]
      var mid = items[2]
      var date = chatHistory[i]["localDate"]
      var new_date = new Date(date).setHours(0,0,0,0)

      if(new_date != statusDate.setHours(0,0,0,0)){
        statusDate = new Date(new_date)
        addHistoryStatus(statusDate)
      }
      chatarea.innerHTML += buildMessage(name, mid, clientMid, message, date)
    } else if(chatHistory[i]["type"]=="proposal"){
      var new_date = new Date(1000 * chatHistory[i]["timestamp"]).setHours(0,0,0,0)
      if(new_date != statusDate.setHours(0,0,0,0)){
        statusDate = new Date(new_date)
        addHistoryStatus(statusDate)
      }
      addGame(chatHistory[i], new Date(1000 * chatHistory[i]["timestamp"]))
    }


  }
  //scroll to the bottom
  $('#chatarea').scrollTop($('#chatarea')[0].scrollHeight)

}


function addStatus(data){
  var chatarea = document.querySelector("#chatarea")
  var buildMessage = '<br><div class="statusUpdate"><p>' + formatDate(new Date()) + '</p><br><p>' + data + '</p></div><br>'
  chatarea.innerHTML += buildMessage
}

function addGame(data, date=new Date()){

  var chatarea = document.querySelector("#chatarea")

  var game = data.game
  let reservation_block = '<br>'
  if (game.reservation_link != "" && game.reservation_link != "null" && "reservation_link" in game){
    reservation_block += '<p><a target="_blank" href="' + game.reservation_link + '">📖 Réserver</a></p>'
  }

  if (game.club_tel != "" && game.club_tel != "null" && "club_tel" in game){
    reservation_block += '<p><a href="tel:' + game.club_tel + '">📞 Appeler</a></p>'
  }
  if (game.club_email != "" && game.club_email != "null" && "club_email" in game){
    reservation_block += '<p><a href="mailto:' + game.club_email + '">✉️ E-mail</a></p>'
  }

  let partner_name = data.message.split(" ")[0]
  let add_to_calendar_block = add_to_calendar(partner_name, game.game_date, game.game_hour, game.club_name, game.club_address)

  var buildMessage = '<br><div class="statusUpdate">'+
                        '<p>' + formatDate(date) + '</p><br>'+
                        '<p>' + data.message + '</p>'+
                        '<div class="proposal">'+
                        '<p>' + game.club_name + '</p>'+
                        '<p>' + game.game_date + '</p>'+
                        '<p>' + game.game_hour + '</p>'+
                        '<p><a href="' + game.club_address_link + '">' + game.club_address + '</a></p>'+
                        reservation_block +
                        '</div>'+
                        add_to_calendar_block +
                        '<p>Parlez-en ici pour s\'organiser !</p>'+
                        '</div>'+
                      '<br>'

  chatarea.innerHTML += buildMessage

  //scroll to the bottom
  $('#chatarea').scrollTop($('#chatarea')[0].scrollHeight)
}

function add_to_calendar(partner_name, game_date, game_hour, club_name, club_address){
let hour1 = parseInt(game_hour.replace(":",""))/100
console.log(hour1+1)
let date1 = new Date(new Date(game_date).setHours(hour1,0,0,0))
let date2 = new Date(new Date(game_date).setHours((hour1+1),0,0,0))

console.log(date2)
let start_date_string = date1.toISOString().replaceAll(/-/g,"").replaceAll(/:/g,"").split(".")[0] + "Z"
let end_date_string = date2.toISOString().replaceAll(/-/g,"").replaceAll(/:/g,"").split(".")[0] + "Z"

let html = '<div class="atc-wrapper">' +
		'<label for="atc-checkbox" class="atc-checkbox-label">Rajouter au calendrier</label>'+
		'<input name="atc-checkbox" class="atc-checkbox" id="atc-checkbox" type="checkbox">'+
		'<div class="atc-links-wrapper">'+
				'<a class="atc-link icon-google" target="_blank" href="https://www.google.com/calendar/render?action=TEMPLATE&amp;text=Wildcard Tennis ('+partner_name+')&amp;dates='+start_date_string+'/'+end_date_string+'&amp;details='+club_name+'&amp;location='+club_address+'&amp;sprop=&amp;sprop=name:">Google Calendar</a>'+
				'<a class="atc-link icon-ical" target="_blank" href="data:text/calendar;charset=utf8,BEGIN:VCALENDAR'+
          'VERSION:2.0'+
          'BEGIN:VEVENT' +
          'URL:https://carlsednaoui.github.io/add-to-calendar-buttons/generator/generator.html' +
          'DTSTART:' + start_date_string +
          'DTEND:' + end_date_string +
          'SUMMARY:Wildcard Tennis ('+partner_name+')' +
          'DESCRIPTION:'+ club_name +
          'LOCATION:' + club_address +
          'END:VEVENT' +
          'END:VCALENDAR">iCal Calendar</a>' +
				 '<a class="atc-link icon-outlook" target="_blank" href="data:text/calendar;charset=utf8,BEGIN:VCALENDAR' +
          'VERSION:2.0' +
          'BEGIN:VEVENT' +
          'URL:https://carlsednaoui.github.io/add-to-calendar-buttons/generator/generator.html' +
          'DTSTART:' + start_date_string +
          'DTEND:' + end_date_string +
          'SUMMARY: Wildcard Tennis (' + partner_name + ')' +
          'DESCRIPTION:' + club_name +
          'LOCATION:' + club_address +
          'END:VEVENT'+
          'END:VCALENDAR">Outlook Calendar</a>'+
          		'</div>'+
          '</div>'
  return html
}

function addHistoryStatus(data){
  var chatarea = document.querySelector("#chatarea")
  var a = ""

  if(typeof(data) == "string"){
    var data = new Date(data)
  }

    a = data.getDate() + "/" + (data.getMonth() + 1)

  var statusMessage = '<br><div class="statusUpdate"><p><strong>' + a + '</strong></p></div><br>'
  chatarea.innerHTML += statusMessage
}

function sendText(){
  text = $('#text').val();
  $('#text').val('');
  socket.emit('text', {msg: text, date: new Date()});
}



function formatDate(date) {
  var a = ""
  if(typeof(date) == "string"){
    date = new Date(date)
  }

  const h = "0" + date.getHours();
  const m = "0" + date.getMinutes();

  return `${h.slice(-2)}:${m.slice(-2)}`;
}

Date.prototype.addHours = function(h) {
  this.setTime(this.getTime() + (h*60*60*1000));
  return this;
}

$(window).load(
  document.getElementById("text").focus()
)

</script>

</html>
